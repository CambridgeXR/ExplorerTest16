<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VR Explorer</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-simple-slider@1.1.0/dist/aframe-simple-slider.min.js"></script>
    
    <link rel="stylesheet" href="style.css">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VR Explorer">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

</head>
<body>

    <div id="home-screen">
        <h1>VR Explorer</h1>
        
        <h2>Step 1: Select Simulation</h2>
        <div class="dropdown-container">
            <select id="dropdown-audiences">
                <option value="">Presentation Audiences...</option>
                </select>
        </div>
        
        <p class="or-divider">or</p>

        <div class="dropdown-container">
            <select id="dropdown-scenarios">
                <option value="">Special Scenarios...</option>
                </select>
        </div>

        <h2>Step 2: Enter Simulation</h2>
        <button id="go-button">Go</button>

        <h3 class="optional-title">Optional Settings</h3>
        <div class="toggle-container">
            <label class="switch">
                <input type="checkbox" id="safe-mode-1">
                <span class="slider"></span>
            </label>
            <span>Safe Mode 1</span>
        </div>
        <div class="toggle-container">
            <label class="switch">
                <input type="checkbox" id="safe-mode-2">
                <span class="slider"></span>
            </label>
            <span>Safe Mode 2</span>
        </div>
        <div class="toggle-container">
            <label class="switch">
                <input type="checkbox" id="safe-mode-3">
                <span class="slider"></span>
            </label>
            <span>Safe Mode 3</span>
        </div>

        <footer>
            <i>VR Explorer 1.1 brought to you by Cambridge VR</i>
        </footer>
    </div>

    <div id="video-screen">
        <a-scene id="vr-scene">
            <a-assets>
                <video id="video-src" loop playsinline crossorigin="anonymous"></video>
            </a-assets>
            
            <a-videosphere src="#video-src"></a-videosphere>

            <a-entity id="camera-rig" position="0 0 0">
                <a-camera id="camera" fov="80">
                    <a-cursor fuse="true" fuse-timeout="1500"></a-cursor>
                </a-camera>
            </a-entity>

            <a-entity id="in-vr-slider" position="0 -0.8 -2" visible="false" 
                      simple-slider="width: 1.0; height: 0.1; value: 0.5"
                      text="value: IPD Adjust; align: center; zOffset: 0.1; color: #FFF; width: 2">
                <a-entity class="slider-thumb" geometry="primitive: plane; width: 0.1; height: 0.1" material="color: #007aff"></a-entity>
            </a-entity>
        </a-scene>

        <button id="back-button">âœ–</button>
    </div>


    <script src="video-data.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Get UI Elements ---
            const homeScreen = document.getElementById('home-screen');
            const videoScreen = document.getElementById('video-screen');
            const dropdownAudiences = document.getElementById('dropdown-audiences');
            const dropdownScenarios = document.getElementById('dropdown-scenarios');
            const goButton = document.getElementById('go-button');
            const backButton = document.getElementById('back-button');
            
            const safeMode1 = document.getElementById('safe-mode-1');
            const safeMode2 = document.getElementById('safe-mode-2');
            const safeMode3 = document.getElementById('safe-mode-3');
            
            const vrScene = document.getElementById('vr-scene');
            const videoAsset = document.getElementById('video-src');
            const camera = document.getElementById('camera');
            const inVrSlider = document.getElementById('in-vr-slider');

            // --- Populate Dropdowns from video-data.js ---
            Object.keys(audienceVideos).forEach(key => dropdownAudiences.add(new Option(key, key)));
            Object.keys(scenarioVideos).forEach(key => dropdownScenarios.add(new Option(key, key)));

            // --- Dropdown Logic (Ensure only one is selected) ---
            dropdownAudiences.addEventListener('change', () => { if (dropdownAudiences.value) dropdownScenarios.value = ''; });
            dropdownScenarios.addEventListener('change', () => { if (dropdownScenarios.value) dropdownAudiences.value = ''; });

            // --- "Go" Button Logic ---
            goButton.addEventListener('click', () => {
                const selectedKey = dropdownAudiences.value || dropdownScenarios.value;
                if (!selectedKey) { alert('Please select a simulation.'); return; }
                const videoInfo = audienceVideos[selectedKey] || scenarioVideos[selectedKey];
                if (!videoInfo) { alert('Could not find video data.'); return; }

                // **Handle Safe Mode 1 (YouTube)**
                if (safeMode1.checked) {
                    window.location.href = videoInfo.youtube;
                    return;
                }
                
                // **Handle Normal VR/2D Mode**
                homeScreen.style.display = 'none';
                videoScreen.style.display = 'block';

                // **Handle Safe Mode 3 (Pillarbox)**
                // This must be set *before* Safe Mode 2, as it overrides it
                if (safeMode3.checked) {
                    camera.setAttribute('camera', 'fov', 75); // Narrow FOV
                }

                // **Handle Safe Mode 2 (Adjustable IPD)**
                // Only show slider if SM2 is on AND SM3 is off
                const isSafeMode2 = safeMode2.checked && !safeMode3.checked;
                inVrSlider.setAttribute('visible', isSafeMode2);
                inVrSlider.setAttribute('simple-slider', 'value', 0.5); 
                if (isSafeMode2) {
                    camera.appendChild(inVrSlider);
                }

                // **Video Loading (Fixes black screen)**
                videoAsset.addEventListener('canplay', () => {
                    // 1. Play video
                    videoAsset.play().catch(error => console.error('Video play failed:', error));
                    
                    // 2. Play A-Frame scene
                    if (vrScene.hasLoaded) vrScene.play();
                    else vrScene.addEventListener('loaded', () => vrScene.play());

                    // 3. Handle Desktop Fullscreen
                    const isMobile = vrScene.isMobile;
                    if (!isMobile) {
                        vrScene.setAttribute('vr-mode-ui', 'enabled', false);
                        document.documentElement.requestFullscreen().catch(e => console.warn('Fullscreen request failed:', e));
                    } else {
                        vrScene.setAttribute('vr-mode-ui', 'enabled', true);
                    }
                }, { once: true }); // Listener runs only once

                // 4. Set source and load
                videoAsset.setAttribute('src', videoInfo.cloudflare);
                videoAsset.load();
            });

            // --- "Back" Button Logic ---
            backButton.addEventListener('click', () => {
                videoScreen.style.display = 'none';
                homeScreen.style.display = 'block';
                
                // Stop and clear video
                videoAsset.pause();
                videoAsset.setAttribute('src', ''); 
                videoAsset.load();
                vrScene.pause();

                // **Cleanup Safe Modes**
                if (inVrSlider.parentNode === camera) {
                    camera.removeChild(inVrSlider);
                }
                camera.setAttribute('camera', 'fov', 80); // Reset FOV

                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
            });

            // --- Safe Mode 2 (IPD Slider) Logic ---
            inVrSlider.addEventListener('sliderchanged', (e) => {
                // Map slider value (0.0 to 1.0) to IPD range (-0.05 to +0.05)
                const ipdValue = (e.detail.value * 0.1) - 0.05; 
                const separation = parseFloat(ipdValue);
                const cameraRig = vrScene.camera; 
                
                if (cameraRig && cameraRig.el.children.length >= 2) {
                    const leftEye = cameraRig.el.children[0];
                    const rightEye = cameraRig.el.children[1];
                    const baseSeparation = 0.032; // Default half-IPD
                    
                    leftEye.setAttribute('position', { x: -baseSeparation + separation, y: 0, z: 0 });
                    rightEye.setAttribute('position', { x: baseSeparation + separation, y: 0, z: 0 });
                }
            });

            // --- PWA Service Worker Registration ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/ExplorerTest16/sw.js')
                        .then(reg => console.log('Service Worker registered.', reg))
                        .catch(err => console.error('Service Worker registration failed:', err));
                });
            }
        });
    </script>
</body>
</html>
